<html>

<head>
    <script src="jquery-3.4.1.js"></script>

</head>

<body>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
    <div id="player"></div>
    <script>

        var player = new Clappr.Player({
            source: "test.m3u8",
            parentId: "#player",
            autoPlay: false, //CHANGE THIS
        });
    </script>
    <script>
        function changeSource(sourceString) {
            console.log("Switching to : " + sourceString)
            console.log(player.core.getCurrentPlayback().name);
            player.configure({

                source: sourceString,
                autoPlay: true, //CHANGE THIS

            })
        }

    </script>
    <script>
        var testing = true;
        var stop = false;
        var xmlHttp = new XMLHttpRequest();
        var cors2 = "https://cors-anywhere.herokuapp.com/";
        var cors = "https://cors.vaindil.xyz/";
        var seasonUrl = "https://f1tv.formula1.com/api/race-season/?fields=year,name,self,has_content,eventoccurrence_urls&year__gt=2017&order=year"
        var urlStart = "https://f1tv.formula1.com"
       // var sessionURLstart = "https://f1tv.formula1.com/api/session-occurrence/?fields=uid,nbc_status,status,editorial_start_time,live_sources_path,data_source_id,available_for_user,global_channel_urls,global_channel_urls__uid,global_channel_urls__slug,global_channel_urls__self,channel_urls,channel_urls__ovps,channel_urls__slug,channel_urls__name,channel_urls__uid,channel_urls__self,channel_urls__driver_urls,channel_urls__driver_urls__driver_tla,channel_urls__driver_urls__driver_racingnumber,channel_urls__driver_urls__first_name,channel_urls__driver_urls__last_name,channel_urls__driver_urls__image_urls,channel_urls__driver_urls__image_urls__image_type,channel_urls__driver_urls__image_urls__url,channel_urls__driver_urls__team_url,channel_urls__driver_urls__team_url__name,channel_urls__driver_urls__team_url__colour,eventoccurrence_url,eventoccurrence_url__slug,eventoccurrence_url__circuit_url,eventoccurrence_url__circuit_url__short_name,session_type_url,session_type_url__name&fields_to_expand=global_channel_urls,channel_urls,channel_urls__driver_urls,channel_urls__driver_urls__image_urls,channel_urls__driver_urls__team_url,eventoccurrence_url,eventoccurrence_url__circuit_url,session_type_url&slug=";
        //var sessionURLstart = "https://f1tv.formula1.com/api/session-occurrence/?fields=global_channel_urls,global_channel_urls__uid,global_channel_urls__slug,global_channel_urls__self,channel_urls,channel_urls__ovps,channel_urls__slug,channel_urls__name,channel_urls__uid,channel_urls__self,channel_urls__driver_urls,channel_urls__driver_urls__driver_tla,channel_urls__driver_urls__driver_racingnumber,channel_urls__driver_urls__first_name,channel_urls__driver_urls__last_name,channel_urls__driver_urls__image_urls,channel_urls__driver_urls__image_urls__image_type,channel_urls__driver_urls__image_urls__url,channel_urls__driver_urls__team_url,channel_urls__driver_urls__team_url__name,channel_urls__driver_urls__team_url__colour,eventoccurrence_url,eventoccurrence_url__slug,eventoccurrence_url__circuit_url,eventoccurrence_url__circuit_url__short_name,session_type_url,session_type_url__name&fields_to_expand=global_channel_urls,channel_urls,channel_urls__driver_urls,channel_urls__driver_urls__image_urls,channel_urls&slug=";
        var sessionURLstart = "https://f1tv.formula1.com/api/session-occurrence/?fields=global_channel_urls,global_channel_urls__uid,global_channel_urls__slug,global_channel_urls__self,channel_urls,channel_urls__slug,channel_urls__name,channel_urls__uid,channel_urls__self,eventoccurrence_url,eventoccurrence_url__slug,eventoccurrence_url__circuit_url,eventoccurrence_url__circuit_url__short_name,session_type_url__name&fields_to_expand=global_channel_urls,channel_urls&slug=";

        xmlHttp.open("GET", cors + seasonUrl, false);
        xmlHttp.send(null);

        var JSONstring = xmlHttp.responseText;
        var seasonJSON = JSON.parse(JSONstring);
        seasonJSON = seasonJSON.objects;
        for (var a = 0; a < seasonJSON.length; a++) { // for each season
            if (a < 1) {
                continue; // skip 2018
            }
            console.log(seasonJSON[a].name)
            for (var b = 0; b < seasonJSON[a].eventoccurrence_urls.length; b++) { // for every event

                var eventURL = urlStart + seasonJSON[a].eventoccurrence_urls[b];
                xmlHttp.open("GET", cors + eventURL, false);
                xmlHttp.send(null);
                var JSONstring = xmlHttp.responseText;
                var eventJSON = JSON.parse(JSONstring);
                console.log(eventJSON.start_date);
                if (isWithinWeek(parseDate(eventJSON.start_date))) {

                } else {
                    continue;
                }


                var eventSessions = eventJSON.sessionoccurrence_urls;


                for (var c = 0; c < eventSessions.length; c++) {

                    var sessionURL = urlStart + eventSessions[c];


                    xmlHttp.open("GET", cors + sessionURL, false);
                    xmlHttp.send(null);
                    var JSONstring = xmlHttp.responseText;
                    var sessionJSON = JSON.parse(JSONstring);
                    if (sessionJSON.name.includes("High Speed Track Test") || sessionJSON.name.includes("High Speed")) {
                        continue; // skip , no content 
                    }

                    slug = sessionJSON.slug;
                    console.log("***** " +slug);
                    //GET SESSION STREAMS
                    var sessionStreamURL = sessionURLstart + slug;
                    xmlHttp.open("GET", cors + sessionStreamURL, false);
                    xmlHttp.send(null);
                    var JSONstring = xmlHttp.responseText;
                    
                    
                    var sessionStreamJSON = JSON.parse(JSONstring);
                    console.log(sessionStreamJSON.objects[0].channel_urls);
                    var perspectives = sessionStreamJSON.objects[0].channel_urls;
                    if (perspectives == null) {
                        continue;
                    }

                    for (var d = 0; d < perspectives.length; d++) {
                        if (testing) {
                            if (stop) {
                                break;
                            }
                        }

                        console.log(seasonJSON[a].name + " || " + eventJSON.name + " || " + sessionJSON.name + " || " + perspectives[d].name);
                        // REMOVE THIS AFTER TESTING 
                        //continue;
                        //
                        
                        perspectiveURL = getPlayableURL(perspectives[d].self);
                        if (perspectiveURL === -1) {
                            continue;
                        } else if (perspectiveURL === -2) {
                            // stop = true;
                        }

                        if (seasonJSON[a].name.includes("2018")) {
                            perspectiveURL = cors + perspectiveURL;
                        }
                        xmlHttp.open("GET", perspectiveURL, false);
                        xmlHttp.send(null);

                        var fileToFix = xmlHttp.responseText.split("\n");


                        var fixedArray = fixArray(fileToFix, perspectiveURL);
                        // break; // uncomment to only get main feed
                    }


                }
            }
        }
        function fixArray(array, url) {
            newArray = new Array;
            //fix url
            var urlRegex = RegExp(`[^\/]*$`);

            url = url.replace(urlRegex, "");


            for (var x = 0; x < array.length; x++) {

                var oldLine = array[x];
                var newLine = "";
                if (!oldLine.includes("https")) {

                    if (oldLine.length > 6 &&
                        (
                            oldLine.substring(0, 5) === "layer" ||
                            oldLine.substring(0, 4) === "clip" ||
                            oldLine.substring(0, 3) === "OTT"

                        )) {
                        newLine = url + oldLine;

                    } else {
                        var regex = RegExp(`[^"]*m3u8`);

                        var temp = oldLine.match(regex);
                        newLine = oldLine.replace(regex, url + temp);

                    }


                }

                if (newLine === "") {
                    newArray.push(oldLine)
                } else {
                    var regex2 = RegExp(`https:\/\/f1tv-cdn[^\.]*\.formula1\.com`);

                    newLine = newLine.replace(regex2, "https://f1tv.secure.footprint.net")

                    newArray.push(newLine);
                    
                }
             //   console.log(newArray[newArray.length-1]);
            }
            
            return newArray;
        }
        function parseDate(dateString) {
            var parts = dateString.split("-");
            var date = new Date(parts[0], parts[1] - 1, parts[2], 0, 0, 0, 0);
            return date;

        }
        function isWithinWeek(date) {
            var now = new Date();
            console.log(now);
            console.log(date);
            var seconds = parseInt((date - now) / 1000);
            var minutes = seconds / 60;
            var hours = minutes / 60;
            var days = hours / 24;
            console.log(days);
            if (days < 7) {
                return true;
            }
            return false;
        }
        function getPlayableURL(assetID) {
            //console.log("ASSET ID : " + assetID);
            var url = "https://f1tv.formula1.com/api/viewings/";
            //var assetID = "/api/channels/chan_9b01938bf1e94d2c942c34a74ea83636/";
            var cors2 = "https://cors-anywhere.herokuapp.com/";
            var formattedID = "";
            var isChannel = false;
            if (assetID.includes("/api/channels/")) {
                isChannel = true;
                formattedID = `{"channel_url":"` + assetID + `"}`
            } else {
                formattedID = `{"asset_url":"` + assetID + `"}`
            }
            console.log(url);
            console.log(formattedID);
            var data = JSON.parse(formattedID);

            x = formattedID;
            var xhr = new XMLHttpRequest();

            xhr.open('POST', cors2 + url, false);

            xhr.send(x);
            if (xhr.status == 400) {
                console.log(xhr.responseText);
            }
            var respData = xhr.responseText;

            if (respData.includes("form_validation_errors")) {

                return -1;

            }
            var respJSON = JSON.parse(respData);
            if (isChannel) {
                return respJSON.tokenised_url;
            } else {
                console.log("************");
                console.log(respJSON);
                return -2;
            }




        }
      







            // $.post(url,data,

            // function(data,status){
            //     console.log(`${data} and status is ${status}`)
            // }
            // );






        //    console.log(data);
        //     var xhr = new XMLHttpRequest();
        //     xhr.open("POST","https://f1tv.formula1.com/api/viewings/",true);



        //     xhr.onreadystatechange = function(){
        //         console.log(this.status);
        //         console.log(this.readyState);
        //         console.log(this.HEADERS_RECEIVED);
        //         console.log(this.responseText);
        //         console.log(this.response);
        //         console.log(this.responseURL);
        //         if(this.readyState=== XMLHttpRequest.DONE  && this.status===200){

        //         }
        //     }
        //     xhr.send(data);



    </script>

</body>

</html>